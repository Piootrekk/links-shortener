import passport from "passport";
import { Strategy as BearerStrategy } from "passport-http-bearer";
import supabase from "../supabase/supabase";
import { NextFunction, Response, Request } from "express";
import { User } from "@supabase/supabase-js";

export type TPasportUser = User & { token: string };

passport.use(
  new BearerStrategy(async (token, done) => {
    try {
      const { data, error } = await supabase.auth.getUser(token);

      if (error || !data) {
        return done(null, false);
      }
      const user = {
        ...data.user,
        token: token,
      } as TPasportUser;
      return done(null, user);
    } catch (error) {
      return done(error);
    }
  })
);

export const passportMiddleware = passport.initialize();
export const authMiddleware = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  passport.authenticate(
    "bearer",
    { session: false },
    (err: unknown, user: TPasportUser) => {
      if (err) {
        return res
          .status(500)
          .json({ message: "Internal Server Error", error: err });
      }
      if (!user) {
        return res.status(401).json({ message: "Unauthorized" });
      }
      req.user = user;
      next();
    }
  )(req, res, next);
};

export const isLoggedIn = (req: Request, res: Response, next: NextFunction) => {
  passport.authenticate(
    "bearer",
    { session: false },
    (err: unknown, user: User) => {
      if (err) {
        return res
          .status(500)
          .json({ message: "Internal Server Error", error: err });
      }
      if (!user) {
        return res.json(null);
      }
      req.user = user;
      next();
    }
  )(req, res, next);
};
