FROM node:20-alpine

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY . .
RUN npx prisma generate
RUN npm run build

ARG PORT=3000
ARG EXPRESS_CRYPT_SECRET
ARG EXPRESS_SUPABASE_KEY
ARG EXPRESS_SUPABASE_URL
ARG EXPRESS_BUCKET_ENDPOINT
ARG EXPRESS_DATABASE_URL
ARG EXPRESS_DIRECT_URL
ARG EXPRESS_URL_BACKEND
ARG EXPRESS_URL_FRONT

ENV PORT=$PORT
ENV EXPRESS_CRYPT_SECRET=$EXPRESS_CRYPT_SECRET
ENV EXPRESS_SUPABASE_KEY=$EXPRESS_SUPABASE_KEY
ENV EXPRESS_SUPABASE_URL=$EXPRESS_SUPABASE_URL
ENV EXPRESS_BUCKET_ENDPOINT=$EXPRESS_BUCKET_ENDPOINT
ENV EXPRESS_DATABASE_URL=$EXPRESS_DATABASE_URL
ENV EXPRESS_DIRECT_URL=$EXPRESS_DIRECT_URL
ENV EXPRESS_URL_BACKEND=$EXPRESS_URL_BACKEND
ENV EXPRESS_URL_FRONT=$EXPRESS_URL_FRONT

EXPOSE $PORT


CMD ["node", "build/src/index.js"]
